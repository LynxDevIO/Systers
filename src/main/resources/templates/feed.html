<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Systers Feed</title>
    <link rel="stylesheet" href="css/feed.css">
    <link rel="stylesheet" href="css/adm.css">

</head>
<body>
<!-- Barra superior -->
<header class="top-bar">
    <div class="logo">Systers</div>
    <nav class="nav-bar">
        <button class="nav-btn" onclick="window.location.href='/feed';">Home</button>
        <button class="nav-btn" onclick="window.location.href='/perfil/me';">Meu Perfil</button>
        <button class="nav-btn" onclick="window.location.href='/grupos';">Grupo</button>
        <button class="nav-btn" onclick="window.location.href='/mentorias';">Mentoria</button>
        <button class="nav-btn" onclick="document.getElementById('logoutForm').submit();">Logout</button>
    </nav>
    <!-- Formulário de Logout Global -->
    <form id="logoutForm" th:action="@{/logout}" method="post" style="display: none;">
        <input type="hidden" name="_csrf" th:value="${_csrf.token}" />
    </form>
</header>


<!-- Container principal -->
<div class="container">
    <!-- Conteúdo principal -->
    <main>
        <!-- ADM -->
        <section th:if="${usuario.autorizacao.toString == 'ADMINISTRADOR'}">
            <!-- Perfis Denunciados -->
            <h2>Perfis Denunciados</h2>
            <div id="reported-profiles-container" class="requests-container">
                <!-- Perfis denunciados serão carregados dinamicamente aqui -->
            </div>
        </section>

        <div class="container" th:if="${usuario.Autorizacao != 'ADMINISTRADOR'}">
            <main>
                <h1>Feed de Postagens</h1>
                <!-- Posts -->
                <div id="posts-container" class="posts-container">
                    <!-- Postagens serão carregadas dinamicamente aqui -->
                </div>
            </main>
        </div>
    </main>
</div>

<!-- Rodapé -->
<footer class="footer">
    <p>&copy; 2024 Systers</p>
</footer>
</body>
</html>

<script>
    // Função para carregar postagens no DOM
    function loadPosts(posts) {
        const postsContainer = document.getElementById("posts-container");
        postsContainer.innerHTML = ""; // Limpa postagens anteriores

        if (posts.length === 0) {
            // Exibe mensagem caso não haja postagens
            const noPostsMessage = document.createElement("div");
            noPostsMessage.className = "no-posts-message";
            noPostsMessage.innerHTML = "<p>Não há postagens para exibir.</p>";
            postsContainer.appendChild(noPostsMessage);
            return; // Sai da função se não houver postagens
        }

        posts.forEach(post => {
            const postElement = document.createElement("div");
            postElement.className = "post";
            postElement.innerHTML = `
              <div class="post-header">
                  <div class="profile-pic"></div>
                  <div class="post-info">
                      <h4>${post.grupo.nome}</h4>
                      <p>${post.autor.usuario.login}</p>
                      <p>${post.conteudo}</p>
                  </div>
              </div>
              <div class="post-content">
                  <p>${post.conteudo}</p>
              </div>
          `;
            postsContainer.appendChild(postElement);
        });
    }

    // Função para carregar postagens do servidor
    async function loadPostsFromServer() {
        try {
            const response = await fetch('/api/postagens/ultimas');
            if (!response.ok) {
                throw new Error('Network response was not ok');
            }
            const posts = await response.json();
            loadPosts(posts); // Chama a função para carregar postagens no DOM
        } catch (error) {
            console.error('Erro ao carregar postagens:', error);
        }
    }

    // Carrega as postagens do servidor
    loadPostsFromServer();
</script>

<script>
    // Função para carregar perfis denunciados no DOM
    function loadReportedProfiles(profiles) {
        const container = document.getElementById("reported-profiles-container");
        container.innerHTML = ""; // Limpa dados anteriores

        if (profiles.length === 0) {
            container.innerHTML = "<p>Nenhum perfil denunciado encontrado.</p>";
            return;
        }

        profiles.forEach(profile => {
            const profileElement = document.createElement("div");
            profileElement.className = "profile";
            profileElement.innerHTML = `
              <div class="profile-info">
                  <h4>${profile.userName}</h4>
                  <p><strong>Motivo:</strong> ${profile.reason}</p>
                  <p><strong>Status:</strong> <span class="status-label">${profile.status}</span></p>
              </div>
              <div class="profile-actions">
                  <button class="btn suspend-btn" onclick="handleProfileAction('${profile.userName}', 'Suspender')">Suspender</button>
                  <button class="btn activate-btn" onclick="handleProfileAction('${profile.userName}', 'Ativar')">Ativar</button>
              </div>
          `;
            container.appendChild(profileElement);
        });
    }

    // Função para manipular ações (Suspender/Ativar)
    function handleProfileAction(userName, action) {
        const profile = reportedProfiles.find(p => p.userName === userName);

        if (!profile) {
            alert("Usuário não encontrado.");
            return;
        }

        if (action === "Suspender" && profile.status !== "Suspenso") {
            profile.status = "Suspenso";
            alert(`O usuário ${userName} foi suspenso.`);
        } else if (action === "Ativar" && profile.status !== "Ativo") {
            profile.status = "Ativo";
            alert(`O usuário ${userName} foi ativado.`);
        } else {
            alert(`O usuário ${userName} já está com o status "${profile.status}".`);
        }

        // Atualiza a interface com o novo status
        loadReportedProfiles(reportedProfiles);
    }

    // Carregar os dados simulados ao iniciar
    loadReportedProfiles(reportedProfiles);
</script>
