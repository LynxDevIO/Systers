<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Systers Feed</title>
    <link rel="stylesheet" href="css/feed.css">
    <link rel="stylesheet" href="css/adm.css">
    <meta name="_csrf" th:content="${_csrf.token}"/>
    <meta name="_csrf_header" th:content="${_csrf.headerName}"/>

</head>
<body>
<!-- Barra superior -->
<header class="top-bar">
    <div class="logo">Systers</div>
    <nav class="nav-bar">
        <button class="nav-btn" onclick="window.location.href='/feed';">Home</button>
        <button class="nav-btn" onclick="window.location.href='/perfil/me';">Meu Perfil</button>
        <button class="nav-btn" onclick="window.location.href='/grupos';">Grupo</button>
        <button class="nav-btn" onclick="window.location.href='/mentorias';">Mentoria</button>
        <button class="nav-btn" onclick="document.getElementById('logoutForm').submit();">Logout</button>
    </nav>
    <!-- Formulário de Logout Global -->
    <form id="logoutForm" th:action="@{/logout}" method="post" style="display: none;">
        <input type="hidden" name="_csrf" th:value="${_csrf.token}" />
    </form>
</header>


<!-- Container principal -->
<div class="container">
    <!-- Conteúdo principal -->
    <main>
        <!-- ADM -->
        <section th:if="${usuario.autorizacao.toString == 'ADMINISTRADOR'}">
            <!-- Perfis Denunciados -->
            <h2>Perfis Denunciados</h2>
            <div id="reported-profiles-container" class="requests-container">
                <!-- Perfis denunciados serão carregados dinamicamente aqui -->
            </div>
        </section>

        <div class="container">
            <main>
                <h1>Feed de Postagens</h1>
                <!-- Posts -->
                <div id="posts-container" class="posts-container">
                    <!-- Postagens serão carregadas dinamicamente aqui -->
                </div>
            </main>
        </div>
    </main>
</div>

<!-- Rodapé -->
<footer class="footer">
    <p>&copy; 2024 Systers</p>
</footer>
</body>
</html>

<script>
    // Função para carregar postagens no DOM
    function loadPosts(posts) {
        console.log('Posts recebidos:', posts);
        const postsContainer = document.getElementById("posts-container");
        postsContainer.innerHTML = ""; 

        if (posts.length === 0) {
            const noPostsMessage = document.createElement("div");
            noPostsMessage.className = "no-posts-message";
            noPostsMessage.innerHTML = "<p>Não há postagens para exibir.</p>";
            postsContainer.appendChild(noPostsMessage);
            return;
        }

        posts.forEach(post => {
            const postElement = document.createElement("div");
            postElement.className = "post";
            postElement.innerHTML = `
                <div class="post-header">
                    <div class="profile-pic"></div>
                    <div class="post-info">
                        <h4>${post.autor.nome}</h4>
                        <p>@${post.autor.tag}</p>
                        <p class="post-date">${formatDate(post.dataCriacao)}</p>
                    </div>
                </div>
                <div class="post-content">
                    <p>${post.conteudo}</p>
                </div>
            `;
            postsContainer.appendChild(postElement);
        });
    }

    // Adicionar função auxiliar para formatar a data
    function formatDate(dateString) {
        const date = new Date(dateString);
        return date.toLocaleDateString('pt-BR', {
            day: '2-digit',
            month: '2-digit',
            year: 'numeric',
            hour: '2-digit',
            minute: '2-digit'
        });
    }

    // Função para carregar postagens do servidor
    async function loadPostsFromServer() {
        try {
            const response = await fetch('/api/postagens/ultimas');
            if (!response.ok) {
                const errorText = await response.text();
                console.error('Erro na resposta:', response.status, errorText);
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            const posts = await response.json();
            console.log('Posts recebidos do servidor:', posts);
            loadPosts(posts);
        } catch (error) {
            console.error('Erro ao carregar postagens:', error);
            const postsContainer = document.getElementById("posts-container");
            postsContainer.innerHTML = `<p class="error-message">Erro ao carregar postagens: ${error.message}</p>`;
        }
    }

    // Carrega as postagens do servidor
    loadPostsFromServer();
</script>

<script>
    // Função para carregar perfis denunciados no DOM
    function loadReportedProfiles(profiles) {
        const container = document.getElementById("reported-profiles-container");
        container.innerHTML = "";

        if (profiles.length === 0) {
            container.innerHTML = "<p>Nenhum perfil denunciado encontrado.</p>";
            return;
        }

        profiles.forEach(profile => {
            const denunciasAtivas = profile.denunciasRecebidas.filter(d => 
                d.status === 'PENDENTE' || d.status === 'EM_ANALISE'
            ).length;

            const profileElement = document.createElement("div");
            profileElement.className = "profile-card";
            profileElement.innerHTML = `
                <div class="profile-info">
                    <h4>${profile.nome}</h4>
                    <p>@${profile.login}</p>
                    <p><strong>Status:</strong> ${profile.statusConta}</p>
                    <p><strong>Denúncias ativas:</strong> ${denunciasAtivas}</p>
                    <p><strong>Total de denúncias:</strong> ${profile.denunciasRecebidas.length}</p>
                </div>
                <div class="profile-actions">
                    <button onclick="handleProfileAction(${profile.id}, 'SUSPENDER')" 
                        ${profile.statusConta === 'SUSPENSO' ? 'disabled' : ''}>
                        Suspender
                    </button>
                    <button onclick="handleProfileAction(${profile.id}, 'BANIR')"
                        ${profile.statusConta === 'BANIDO' ? 'disabled' : ''}>
                        Banir
                    </button>
                    <button onclick="handleProfileAction(${profile.id}, 'ATIVAR')"
                        ${profile.statusConta === 'NORMAL' ? 'disabled' : ''}>
                        Ativar
                    </button>
                </div>
            `;
            container.appendChild(profileElement);
        });
    }

    // Função para carregar os perfis denunciados do servidor
    async function loadReportedProfilesFromServer() {
        try {
            const response = await fetch('/api/usuarios/denunciados');
            if (!response.ok) {
                const errorText = await response.text();
                console.error('Erro na resposta:', response.status, errorText);
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            const profiles = await response.json();
            console.log('Perfis denunciados recebidos:', profiles);
            loadReportedProfiles(profiles);
        } catch (error) {
            console.error('Erro ao carregar perfis denunciados:', error);
            const container = document.getElementById("reported-profiles-container");
            container.innerHTML = `<p class="error-message">Erro ao carregar perfis denunciados: ${error.message}</p>`;
        }
    }

    // Função para lidar com as ações nos perfis
    async function handleProfileAction(userId, action) {
        try {
            const response = await fetch(`/api/usuarios/${userId}/status`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                    // Adicione o token CSRF se necessário
                    'X-CSRF-TOKEN': document.querySelector('meta[name="_csrf"]').content
                },
                body: JSON.stringify({ status: action })
            });

            if (!response.ok) {
                throw new Error('Falha ao atualizar status do usuário');
            }

            // Recarrega a lista de perfis denunciados
            loadReportedProfilesFromServer();
        } catch (error) {
            console.error('Erro ao executar ação:', error);
            alert('Erro ao executar ação: ' + error.message);
        }
    }

    // Carrega os perfis denunciados se o usuário for administrador
    if (document.getElementById('reported-profiles-container')) {
        loadReportedProfilesFromServer();
    }
</script>
